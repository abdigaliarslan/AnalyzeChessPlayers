<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Chess Analysis</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 600px;
    margin: 50px auto;
    padding: 20px;
  }

  input[type="file"], select, button {
    width: 100%;
    padding: 10px;
    margin-bottom: 10px;
    font-size: 14px;
  }

  button {
    background: #4CAF50;
    color: white;
    border: none;
    cursor: pointer;
  }

  button:disabled {
    background: #ccc;
    cursor: not-allowed;
  }

  pre {
    background: #f5f5f5;
    padding: 15px;
    border-radius: 4px;
    white-space: pre-wrap;
  }

  #status {
    margin-bottom: 10px;
    font-weight: bold;
  }

  .analyzing {
    color: #ff9800;
  }

  .done {
    color: #4CAF50;
  }

  .error {
    color: #f44336;
  }

  .spinner {
    display: inline-block;
    width: 12px;
    height: 12px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #ff9800;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 5px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>
</head>
<body>

<h2 id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>

<input type="file" id="fileInput" multiple accept=".pgn">
<button id="uploadBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
<div id="status"></div>

<select id="historySelect" size="10">
  <option>–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞—è</option>
</select>

<pre id="result">–í—ã–±–µ—Ä–∏—Ç–µ –∞–Ω–∞–ª–∏–∑ –∏–∑ —Å–ø–∏—Å–∫–∞</pre>

<script>
const token = localStorage.getItem("access_token");
let isUploading = false;

fetch("/me", { headers: { "Authorization": "Bearer " + token } })
  .then(res => res.json())
  .then(user => {
    document.getElementById("userName").innerText = user.username;
    loadHistory();
  });

document.getElementById("uploadBtn").addEventListener("click", async () => {
  const files = document.getElementById("fileInput").files;
  if (!files.length) return;
  if (isUploading) return;

  isUploading = true;
  const uploadBtn = document.getElementById("uploadBtn");
  uploadBtn.disabled = true;
  
  const statusDiv = document.getElementById("status");
  statusDiv.className = "analyzing";
  statusDiv.innerHTML = '<span class="spinner"></span>–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è —Ñ–∞–π–ª—ã...';

  for (let file of files) {
    statusDiv.innerHTML = `<span class="spinner"></span>–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è —Ñ–∞–π–ª: ${file.name}`;
    
    const formData = new FormData();
    formData.append("file", file);
    
    try {
      await fetch("/upload", {
        method: "POST",
        headers: { "Authorization": "Bearer " + token },
        body: formData
      });
      
      await loadHistory();
    } catch (err) {
      statusDiv.className = "error";
      statusDiv.innerText = `–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ${file.name}`;
    }
  }

  statusDiv.className = "done";
  statusDiv.innerText = "‚úì –í—Å–µ —Ñ–∞–π–ª—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã";
  uploadBtn.disabled = false;
  isUploading = false;
  
  setTimeout(() => {
    statusDiv.innerText = "";
  }, 3000);
});

async function loadHistory() {
  const res = await fetch("/history", { headers: { "Authorization": "Bearer " + token } });
  const data = await res.json();
  
  const select = document.getElementById("historySelect");
  const currentValue = select.value;
  
  select.innerHTML = data.map(record => {
    let status = "queued";
    if (record.status) {
      status = typeof record.status === 'string' ? record.status : record.status.value || "queued";
    }
    
    const statusText = {
      'queued': '‚è≥ –í –æ—á–µ—Ä–µ–¥–∏',
      'processing': 'üîÑ –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è',
      'done': '‚úì –ì–æ—Ç–æ–≤–æ',
      'failed': '‚úó –û—à–∏–±–∫–∞'
    }[status] || status;
    
    const result = record.result_text || "–†–µ–∑—É–ª—å—Ç–∞—Ç –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤...";
    const pgnPreview = record.pgn_content ? record.pgn_content.slice(0,30) + (record.pgn_content.length > 30 ? '...' : '') : '';
    
    return `<option value="${record.id}" data-result="${result}" data-status="${status}">#${record.id} ‚Äî ${pgnPreview} [${statusText}]</option>`;
  }).join("");
  
  if (currentValue) {
    select.value = currentValue;
  }
}

document.getElementById("historySelect").addEventListener("change", (e) => {
  const option = e.target.selectedOptions[0];
  if (!option) return;
  
  const status = option.dataset.status || "queued";
  const result = option.dataset.result || "–†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç";
  
  const statusText = {
    'queued': '–í –æ—á–µ—Ä–µ–¥–∏ –Ω–∞ –∞–Ω–∞–ª–∏–∑',
    'processing': '–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è...',
    'done': '–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω',
    'failed': '–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞'
  }[status] || status;
  
  document.getElementById("result").innerText = `–°—Ç–∞—Ç—É—Å: ${statusText}\n\n–†–µ–∑—É–ª—å—Ç–∞—Ç:\n${result}`;
});

setInterval(loadHistory, 5000);
</script>

</body>
</html>